---
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ContactCTA from "../../components/ContactCTA.astro";
import AudioPlayer from "../../components/AudioPlayer.astro";
import { formatDate } from "../../utils/date";
import fs from "node:fs";
import path from "node:path";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await post.render();

// Check if audio file exists
const audioPath = `/audio/${post.slug}.mp3`;
const audioFileExists = fs.existsSync(
  path.join(process.cwd(), "public", "audio", `${post.slug}.mp3`)
);
---

<Layout
  title={`${post.data.title} – Stefan Gasser`}
  description={post.data.description}
  ogImage={`/og/${post.slug}.png`}
  ogType="article"
>
  <Header />

  <main>
    <article
      class="mx-auto max-w-3xl px-6 pt-8 pb-16 lg:px-8 lg:pt-12 lg:pb-24"
    >
      <header class="mb-12">
        <a
          href="/blog"
          class="inline-flex items-center gap-1 text-sm text-gray-600 hover:text-primary-700 transition-colors"
        >
          <svg
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
          </svg>
          Zurück zum Blog
        </a>
        <h1
          class="mt-8 text-3xl font-bold tracking-tight text-gray-800 sm:text-4xl"
        >
          {post.data.title}
        </h1>
        <time
          datetime={post.data.pubDate.toISOString()}
          class="mt-3 block text-sm text-gray-600"
        >
          {formatDate(post.data.pubDate)}
        </time>
        {
          post.data.description && (
            <p class="mt-4 text-lg text-gray-600">{post.data.description}</p>
          )
        }

        {
          audioFileExists && (
            <AudioPlayer src={audioPath} title="Artikel anhören" class="mt-6" />
          )
        }
      </header>

      <div
        class="prose prose-lg prose-gray max-w-none prose-headings:font-semibold prose-headings:text-gray-800 prose-a:text-primary-700 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-800 prose-code:text-primary-700 prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none prose-blockquote:border-primary-500 prose-blockquote:text-gray-700 prose-table:text-sm"
      >
        <Content />
      </div>

      <footer class="mt-16 pt-8 border-t border-gray-200">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-primary-700 hover:text-primary-800 font-medium transition-colors rounded focus-visible:outline focus-visible:outline-2 focus-visible:outline-primary-600"
        >
          <svg
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
          </svg>
          Alle Artikel
        </a>
      </footer>

      <ContactCTA class="mt-12" />
    </article>
  </main>

  <Footer />
</Layout>
